# üìò Finance Collections Voucher Consumer

This service acts as a **bridge between the Collection Service (collects payment for bills from CITIZEN and EMPLOYEE for the bills generated by revenue services using different modes of services of online and offline(employee counter)) and the Finance/ERP System**. It listens to collection-related events from Kafka and creates/cancels vouchers and payment instruments(egf-instrument service used to create, search, update and delete instruments) accordingly.

---

## üîç Overview

The `finance-collections-voucher-consumer` service:

- Creates vouchers and instruments for successful receipts
- Cancels vouchers and instruments on payment cancellation
- Handles both Collection V1 and V2 flows
- Integrates with ERP and Instrument services
- Logs all operations for audit and traceability

---

## ‚úÖ Key Features

- Voucher creation for successful payments
- Instrument (cash, cheque, DD, etc.) creation
- Voucher & instrument cancellation on payment reversal
- Support for both Collection V1 and V2 flows
- Full logging of all operations

---

## üß© Kafka Topics Listened To

| Topic Name                             | Description                           |
|----------------------------------------|---------------------------------------|
| `egov.collection.receipt-create`       | Receipt creation (Collection V1)      |
| `egov.collection.receipt-cancel`       | Receipt cancellation (Collection V1)  |
| `egov.collection.payment-create`       | Payment creation (Collection V2)      |
| `egov.collection.payment-cancel`       | Payment cancellation (Collection V2)  |

---

## üîÅ Service Flow

###  On Receipt/Payment Creation

1. Receive message from Kafka topic
2. Check if tenant is enabled in the finance module
3. Validate if voucher already exists
4. If voucher creation is enabled:
    - Create a voucher in ERP
    - Update receipt with voucher number
    - Create payment instrument
5. Log success or failure to DB



### On Receipt/Payment Cancellation

1. Search for existing voucher by service and reference
2. Validate status (must not be already cancelled)
3. Cancel voucher in ERP
4. Cancel corresponding instrument
5. Log the operation

---

##  Core Services

| Service Name        | Responsibility                             |
|---------------------|---------------------------------------------|
| `VoucherService`     | Handles creation & cancellation of vouchers |
| `InstrumentService`  | Manages payment instruments                 |

---

##  Integration Points

| Service              | Purpose                                   |
|----------------------|-------------------------------------------|
| ERP Finance System   | Voucher creation & cancellation           |
| Instrument Service   | Instrument creation & cancellation        |
| Collection Service   | Source of receipts/payments               |
| MDMS                 | Provides finance-related master data      |

---

## Running Locally

To test the service locally, follow these steps:

### 1. Start the Service

```bash
mvn clean install
java -jar target/finance-collections-voucher-consumer.jar
```

### 1. Run Dependent Services
Make sure the following services are running locally:

 Collection Service

 Billing Service

 Property Service (used for payment flow)

Ô∏è MDMS Service

### 3. Port Forward the Following Services
Use kubectl port-forward to make the following services accessible locally:

 idgen-service

 enc-service

 persister-service

 apportion-service

 user-service

 localization-service

 instrument-service


### 4. Testing with Payment CURL
You can test the payment flow using the following CURL command:

sample CURL command provided in the documentation to simulate a payment and test the flow:

üìÑ Google Docs: https://docs.google.com/document/d/1iw2Jb6LCSCmBz30KpUi1dC3anlVP-h5McimppteBxzE/edit?tab=t.5hl565mwz3i0



